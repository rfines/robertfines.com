name: Deploy

on:
  workflow_run:
    workflows: [CI]
    branches: [main]
    types: [completed]

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    # Only deploy if CI passed on main
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: production
      url: https://robertfines.com

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy web
        working-directory: apps/web
        run: railway up --service ${{ vars.RAILWAY_WEB_SERVICE }} --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy api
        working-directory: apps/api
        run: railway up --service ${{ vars.RAILWAY_API_SERVICE }} --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy shortlist
        working-directory: apps/shortlist
        run: railway up --service ${{ vars.RAILWAY_SHORTLIST_SERVICE }} --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
